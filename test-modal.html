<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exit Modal Test</title>
    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.hidden {
            display: none;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-header h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .warning-text {
            color: #e67e22;
            font-size: 0.9em;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn--outline {
            background: transparent;
            border: 1px solid #ccc;
            color: #333;
        }
        
        .btn--danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn--primary {
            background: #3498db;
            color: white;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        .test-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .console-output {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Exit Confirmation Modal Test</h1>
        <p>This test demonstrates the exit confirmation modal functionality for GitHub Pages compatibility.</p>
        
        <button id="exit-exam-btn" class="btn btn--danger">Exit Exam</button>
        <button id="submit-test-btn" class="btn btn--primary">Submit Test</button>
        
        <div class="console-output" id="console-output">
            <div>Console output will appear here...</div>
        </div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div id="exit-confirmation-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="exit-modal-title" aria-describedby="exit-modal-desc">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="exit-modal-title">Exit Exam Confirmation</h3>
            </div>
            <div class="modal-body">
                <p id="exit-modal-desc">Are you sure you want to exit the exam?</p>
                <p class="warning-text">‚ö†Ô∏è Your progress will be saved, but the timer will stop.</p>
            </div>
            <div class="modal-footer">
                <button id="cancel-exit-btn" class="btn btn--outline">Cancel</button>
                <button id="confirm-exit-btn" class="btn btn--danger">Exit Exam</button>
            </div>
        </div>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submit-confirmation-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="submit-modal-title" aria-describedby="submit-modal-desc">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="submit-modal-title">Submit Test Confirmation</h3>
            </div>
            <div class="modal-body">
                <p id="submit-modal-desc">Are you sure you want to submit your test?</p>
                <p class="warning-text">‚ö†Ô∏è You cannot change your answers after submission.</p>
            </div>
            <div class="modal-footer">
                <button id="cancel-submit-btn" class="btn btn--outline">Cancel</button>
                <button id="confirm-submit-btn" class="btn btn--primary">Submit Test</button>
            </div>
        </div>
    </div>

    <!-- Mock app container -->
    <div id="app-container" style="display: none;"></div>

    <script>
        // Mock utility functions
        window.Utils = {
            showToast: function(message, type) {
                logToConsole(`Toast (${type}): ${message}`);
            }
        };

        // Mock testManager
        window.testManager = {
            submitTest: function() {
                logToConsole('üì§ testManager.submitTest() called');
            },
            exitExam: function() {
                logToConsole('üö™ testManager.exitExam() called');
            }
        };

        function logToConsole(message) {
            const output = document.getElementById('console-output');
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        // Simplified MockTestApp class for testing
        class MockTestApp {
            constructor() {
                this.viewManager = {
                    showView: (view) => logToConsole(`ViewManager: showing ${view} view`)
                };
                // Android ghost-tap prevention
                this._gestureLockUntil = 0;
                this._modalOpen = false;
            }

            showExitConfirmationModal() {
                const modal = document.getElementById('exit-confirmation-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    this._modalOpen = true;
                    logToConsole('üëÅÔ∏è Exit confirmation modal shown');
                } else {
                    logToConsole('‚ö†Ô∏è Exit confirmation modal not found, falling back to confirm()');
                    if (confirm('Are you sure you want to exit the exam? Your progress will be saved.')) {
                        if (window.testManager && typeof window.testManager.exitExam === 'function') {
                            window.testManager.exitExam();
                        } else if (window.testManager && typeof window.testManager.submitTest === 'function') {
                            window.testManager.submitTest();
                        } else {
                            this.backToHome();
                        }
                    }
                }
            }

            hideExitConfirmationModal() {
                const modal = document.getElementById('exit-confirmation-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    this._modalOpen = false;
                    logToConsole('üëÅÔ∏è Exit confirmation modal hidden');
                }
            }

            showSubmitConfirmationModal() {
                const modal = document.getElementById('submit-confirmation-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    this._modalOpen = true;
                    logToConsole('üëÅÔ∏è Submit confirmation modal shown');
                } else {
                    logToConsole('‚ö†Ô∏è Submit confirmation modal not found, falling back to confirm()');
                    if (confirm('Are you sure you want to submit your test? You cannot change your answers after submission.')) {
                        if (window.testManager && typeof window.testManager.performSubmit === 'function') {
                            window.testManager.performSubmit();
                        }
                    }
                }
            }

            hideSubmitConfirmationModal() {
                const modal = document.getElementById('submit-confirmation-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    this._modalOpen = false;
                    logToConsole('üëÅÔ∏è Submit confirmation modal hidden');
                }
            }

            backToHome() {
                logToConsole('üè† Navigating back to home');
                this.viewManager.showView('landing');
            }

            showError(message) {
                logToConsole(`Error: ${message}`);
                if (window.Utils && window.Utils.showToast) {
                    window.Utils.showToast(message, 'error');
                } else {
                    alert(message);
                }
            }

            setupGlobalEventDelegation() {
                const appContainer = document.getElementById('app-container');
                if (!appContainer) {
                    logToConsole('‚ùå App container not found! Using body instead.');
                    // For this test, we'll use document.body
                }

                const buttonStates = new Map();

                document.addEventListener('click', (e) => {
                    const target = e.target;
                    const button = target.closest('button');
                    const buttonId = button ? button.id : target.id;
                    const actualTarget = target.tagName === 'BUTTON' ? target : button;

                    if (!actualTarget || !buttonId) {
                        return;
                    }

                    logToConsole(`üîò Button clicked: ${buttonId}`);

                    if (buttonStates.get(buttonId)) {
                        logToConsole(`‚è≥ Button ${buttonId} is already being processed, ignoring click`);
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }

                    const setProcessing = (processing) => {
                        buttonStates.set(buttonId, processing);
                        if (actualTarget) {
                            actualTarget.disabled = processing;
                            actualTarget.dataset.processing = processing.toString();
                        }
                    };

                    switch (buttonId) {
                        case 'submit-test-btn':
                            e.preventDefault();
                            e.stopPropagation();
                            logToConsole('üì§ Submit test button clicked');
                            
                            setProcessing(true);
                            this.showSubmitConfirmationModal();
                            setTimeout(() => setProcessing(false), 1000);
                            break;

                        case 'confirm-submit-btn':
                            e.preventDefault();
                            e.stopPropagation();
                            logToConsole('‚úÖ Confirm submit button clicked');
                            
                            setProcessing(true);
                            this.hideSubmitConfirmationModal();
                            
                            if (window.testManager && typeof window.testManager.performSubmit === 'function') {
                                logToConsole('üéØ Calling performSubmit method');
                                window.testManager.performSubmit();
                            } else {
                                logToConsole('‚ö†Ô∏è performSubmit method not available');
                                this.showError('Cannot submit test - test manager not ready');
                            }
                            setTimeout(() => setProcessing(false), 500);
                            break;

                        case 'cancel-submit-btn':
                            e.preventDefault();
                            e.stopPropagation();
                            logToConsole('‚ùå Cancel submit button clicked');
                            
                            this.hideSubmitConfirmationModal();
                            break;

                        case 'exit-exam-btn':
                            e.preventDefault();
                            e.stopPropagation();
                            logToConsole('üö™ Exit exam button clicked');
                            
                            setProcessing(true);
                            this.showExitConfirmationModal();
                            setTimeout(() => setProcessing(false), 500);
                            break;

                        case 'confirm-exit-btn':
                            e.preventDefault();
                            e.stopPropagation();
                            logToConsole('‚úÖ Confirm exit button clicked');
                            
                            setProcessing(true);
                            this.hideExitConfirmationModal();
                            
                            if (window.testManager && typeof window.testManager.exitExam === 'function') {
                                logToConsole('üéØ Calling exitExam method');
                                window.testManager.exitExam();
                            } else if (window.testManager && typeof window.testManager.submitTest === 'function') {
                                logToConsole('üéØ exitExam not available, calling submitTest as fallback');
                                window.testManager.submitTest();
                            } else {
                                logToConsole('‚ö†Ô∏è Neither exitExam nor submitTest methods are available');
                                this.backToHome();
                            }
                            setTimeout(() => setProcessing(false), 500);
                            break;

                        case 'cancel-exit-btn':
                            e.preventDefault();
                            e.stopPropagation();
                            logToConsole('‚ùå Cancel exit button clicked');
                            
                            this.hideExitConfirmationModal();
                            break;
                    }
                });

                logToConsole('‚úÖ Global event delegation setup complete');
            }
        }

        // Initialize the test
        document.addEventListener('DOMContentLoaded', () => {
            logToConsole('üöÄ DOM loaded, initializing test...');
            
            window.app = new MockTestApp();
            window.app.setupGlobalEventDelegation();
            
            logToConsole('‚úÖ Test initialized successfully');
            logToConsole('üìù Click the "Exit Exam" button to test the modal functionality');
        });
    </script>
</body>
</html>